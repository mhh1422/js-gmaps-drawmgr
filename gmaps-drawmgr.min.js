function drawMgr(_map,_options,_saveHandler,_loadHandler,_consoleHandler){function typeDesc(e){switch(e){case RECTANGLE:return"rectangle";case CIRCLE:return"circle";case POLYGON:return"polygon";case POLYLINE:return"polyline";case MARKER:return"marker";case null:return"null";default:return"UNKNOWN GOOGLE MAPS OVERLAY TYPE"}}function jsonReadPath(e){for(var n=new google.maps.MVCArray,a=0;a<e.path.length;a++){var o=new google.maps.LatLng(e.path[a].lat,e.path[a].lng);n.push(o)}return n}function jsonReadRectangle(e){var n=e,a=new google.maps.LatLng(n.bounds.southWest.lat,n.bounds.southWest.lng),o=new google.maps.LatLng(n.bounds.northEast.lat,n.bounds.northEast.lng),t=new google.maps.LatLngBounds(a,o),s={bounds:t,editable:!1,fillColor:n.color,map:_map},r=new google.maps.Rectangle(s);return r}function jsonReadCircle(e){var n=e,a=new google.maps.LatLng(n.center.lat,n.center.lng),o={center:a,radius:parseFloat(n.radius),editable:!1,fillColor:n.color,map:_map},t=new google.maps.Circle(o);return t}function jsonReadPolyline(e){var n=jsonReadPath(e),a={path:n,editable:!1,strokeColor:e.color,map:_map},o=new google.maps.Polyline(a);return o}function jsonReadPolygon(e){for(var n=new google.maps.MVCArray,a=0;a<e.paths.length;a++){var o=jsonReadPath(e.paths[a]);n.push(o)}var t={paths:n,editable:!1,fillColor:e.color,map:_map},s=new google.maps.Polygon(t);return s}function jsonRead(e){for(i=0;i<e.shapes.length;i++)switch(e.shapes[i].type){case RECTANGLE:var n=jsonReadRectangle(e.shapes[i]);newShapeSetProperties(n,RECTANGLE),newShapeAddListeners(n),shapesAdd(n);break;case CIRCLE:var a=jsonReadCircle(e.shapes[i]);newShapeSetProperties(a,CIRCLE),newShapeAddListeners(a),shapesAdd(a);break;case POLYLINE:var o=jsonReadPolyline(e.shapes[i]);newShapeSetProperties(o,POLYLINE),newShapeAddListeners(o),shapesAdd(o);break;case POLYGON:var t=jsonReadPolygon(e.shapes[i]);newShapeSetProperties(t,POLYGON),newShapeAddListeners(t),shapesAdd(t)}}function comma(e){return e>0?",":""}function jsonMakeLatLng(e){var n='"lat":"'+e.lat()+'","lng":"'+e.lng()+'"';return n}function jsonMakeBounds(e){var n='"bounds":{"northEast":{'+jsonMakeLatLng(e.getNorthEast())+'},"southWest":{'+jsonMakeLatLng(e.getSouthWest())+"}}";return n}function jsonMakeType(e){var n='"type":"'+typeDesc(e)+'"';return n}function jsonMakeColor(e){var n='"color":"'+e+'"';return n}function jsonMakeCenter(e){var n='"center":{'+jsonMakeLatLng(e)+"}";return n}function jsonMakeRadius(e){var n='"radius":"'+e+'"';return n}function jsonMakePath(e){for(var n=e.getLength(),a='"path":[',o=0;n>o;o++){var t=e.getAt(o);a+=comma(o)+"{"+jsonMakeLatLng(t)+"}"}return a+="]"}function jsonMakePaths(e){for(var n=e.getLength(),a='"paths":[',o=0;n>o;o++){var t=e.getAt(o);a+=comma(o)+"{"+jsonMakePath(t)+"}"}return a+="]"}function jsonMakeRectangle(e){var n=jsonMakeType(RECTANGLE)+","+jsonMakeColor(e.fillColor)+","+jsonMakeBounds(e.bounds);return n}function jsonMakeCircle(e){var n=jsonMakeType(CIRCLE)+","+jsonMakeColor(e.fillColor)+","+jsonMakeCenter(e.center)+","+jsonMakeRadius(e.radius);return n}function jsonMakePolyline(e){var n=jsonMakeType(POLYLINE)+","+jsonMakeColor(e.strokeColor)+","+jsonMakePath(e.getPath());return n}function jsonMakePolygon(e){var n=jsonMakeType(POLYGON)+","+jsonMakeColor(e.fillColor)+","+jsonMakePaths(e.getPaths());return n}function jsonMake(){var e='{"shapes":[';for(i=0;i<_shapes.length;i++)switch(_shapes[i].type){case RECTANGLE:e+=comma(i)+"{"+jsonMakeRectangle(_shapes[i])+"}";break;case CIRCLE:e+=comma(i)+"{"+jsonMakeCircle(_shapes[i])+"}";break;case POLYLINE:e+=comma(i)+"{"+jsonMakePolyline(_shapes[i])+"}";break;case POLYGON:e+=comma(i)+"{"+jsonMakePolygon(_shapes[i])+"}"}return e+="]}"}function shapesAdd(e){_shapes.push(e)}function shapesDelete(e){for(var n=!1,a=0;a<_shapes.length&&!n;a++)_shapes[a]===e&&(_shapes.splice(a,1),n=!0)}function shapesHideAll(){for(var e=0;e<_shapes.length;e++)_shapes[e].setMap(null)}function shapesDeleteAll(){print(_shapes.length+" shapes deleted\n"),_shapes.splice(0,_shapes.length)}function shapesSave(){var e=jsonMake();_saveHandler&&"function"==typeof _saveHandler?_saveHandler(e):_saveHandler&&"string"==typeof _saveHandler&&"cookie"==_saveHandler?saveToCookie(e):console.warn("No handler to save shapes",e)}function saveToCookie(e){var n=new Date;n.setDate(n.getDate+365);var a=escape(e)+"; expires="+n.toUTCString();document.cookie="shapes="+a}function shapesLoad(){var e=null,n=_shapes.length;_loadHandler&&"function"==typeof _loadHandler?e=_loadHandler():_loadHandler&&"string"==typeof _loadHandler&&"cookie"==_loadHandler?e=loadFromCookie():console.warn("No handler to load shapes"),e&&jsonRead(e);var a=_shapes.length-n;print(a+" shapes loaded\n")}function loadFromCookie(){for(var shapes=null,cookies=document.cookie.split(";"),i=0;i<cookies.length;i++){var key=cookies[i].substr(0,cookies[i].indexOf("="));if(key=key.replace("/^s+|s+$/g",""),"shapes"==key){var value=cookies[i].substr(cookies[i].indexOf("=")+1);shapes=unescape(value);break}}return eval("("+shapes+")")}function print(e){_consoleHandler!==!1&&(_consoleHandler&&"function"==typeof _consoleHandler?_consoleHandler(e):console.log(e))}function printDrawingMode(e){print("drawing mode set to "+typeDesc(e.getDrawingMode())+"\n")}function selectionPrint(){print(null==_selection?"selection cleared\n":_selection.appId+": selected\n")}function selectionIsSet(){return null!=_selection}function selectionSet(e){e!=_selection&&(null!=_selection&&(_selection.setEditable(!1),_selection=null),null!=e&&(_selection=e,_selection.setEditable(drawMgrEnabled())),selectionPrint())}function selectionClear(){selectionSet(null)}function selectionDelete(){null!=_selection&&(_selection.setMap(null),selectionClear())}function newShapeAddPathListeners(e,n){google.maps.event.addListener(n,"insert_at",function(){onShapeEdited(e)}),google.maps.event.addListener(n,"remove_at",function(){onShapeEdited(e)}),google.maps.event.addListener(n,"set_at",function(){onShapeEdited(e)})}function newShapeAddListeners(e){switch(google.maps.event.addListener(e,"click",function(){onShapeClicked(e)}),e.type){case RECTANGLE:google.maps.event.addListener(e,"bounds_changed",function(){onShapeEdited(e)});break;case CIRCLE:google.maps.event.addListener(e,"center_changed",function(){onShapeEdited(e)}),google.maps.event.addListener(e,"radius_changed",function(){onShapeEdited(e)});break;case POLYLINE:var n=e.getPath();newShapeAddPathListeners(e,n);break;case POLYGON:for(var a=e.getPaths(),o=a.getLength(),t=0;o>t;t++){var n=a.getAt(t);newShapeAddPathListeners(e,n)}}}function newShapeSetProperties(e,n){e.type=n,e.appId=_newShapeNextId,_newShapeNextId++}function setMap(e){return google.maps.event.addListener(e,"click",onMapClicked),e}function drawingManagerCreate(e,n){n=n&&"object"==typeof n?n:{};var a=getOption(n,"drawingModes",new Array(RECTANGLE,CIRCLE,POLYGON,POLYLINE)),o=getOption(n,"position",google.maps.ControlPosition.TOP_CENTER),t={drawingModes:a,position:o},s={editable:!0};return drawingManagerOptions={drawingMode:null,drawingControlOptions:t,markerOptions:{draggable:!0},polylineOptions:{editable:!0},rectangleOptions:s,circleOptions:s,polygonOptions:s,map:e},drawingManager=new google.maps.drawing.DrawingManager(drawingManagerOptions),google.maps.event.addListener(drawingManager,"overlaycomplete",onNewShape),google.maps.event.addListener(drawingManager,"drawingmode_changed",onDrawingModeChanged),printDrawingMode(drawingManager),selectionPrint(),drawingManager}function onNewShape(e){var n=e.overlay;newShapeSetProperties(n,e.type),newShapeAddListeners(n),shapesAdd(n),shapesSave(),selectionSet(n),print("new "+typeDesc(e.type)+" created (id = "+n.appId+")\n")}function onShapeEdited(e){print(e.appId+": shape edited\n"),shapesSave()}function onShapeClicked(e){print(e.appId+": shape clicked\n"),selectionSet(e)}function onMapClicked(){print("map clicked\n"),selectionClear()}function onDelete(){print("delete button clicked\n"),selectionIsSet()&&(shapesDelete(_selection),shapesSave(),selectionDelete())}function onClear(){print("clear button clicked\n"),selectionClear(),shapesHideAll(),shapesDeleteAll(),shapesSave()}function onDrawingModeChanged(){printDrawingMode(drawingManager),selectionClear()}function onCreate(){_drawingManager=drawingManagerCreate(_map,_options),google.maps.event.addListener(_map,"click",onMapClicked),drawMgr.clear=onClear,drawMgr.delete=onDelete,drawMgr.disable=disableDrawMgr,drawMgr.enable=enableDrawMgr,drawMgr.enabled=drawMgrEnabled,drawMgr.getJSON=jsonMake,drawMgr.save=shapesSave,drawMgr.load=load,shapesLoad();var e=getOption(_options,"enabled",!0);e||disableDrawMgr()}function getOption(e,n,a){return e.hasOwnProperty(n)?e[n]:a}function disableDrawMgr(){_drawingManager.setMap(null),selectionClear(),_drawingManager.setDrawingMode(null)}function enableDrawMgr(){_drawingManager.setMap(_map)}function drawMgrEnabled(){return null!==_drawingManager.getMap()}function load(){shapesHideAll(),shapesLoad()}var _selection=null,_drawingManager=null,_newShapeNextId=0,_shapes=[],RECTANGLE=google.maps.drawing.OverlayType.RECTANGLE,CIRCLE=google.maps.drawing.OverlayType.CIRCLE,POLYGON=google.maps.drawing.OverlayType.POLYGON,POLYLINE=google.maps.drawing.OverlayType.POLYLINE,MARKER=google.maps.drawing.OverlayType.MARKER;onCreate()}